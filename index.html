<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PilotApp</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<style>
:root {
  --bg:#000;
  --card:#1c1c1e;
  --accent:#0a84ff;
  --border:#2c2c2e;
  --text:#fff;
  --muted:#a1a1a6;
}

body{margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text)}
header{background:var(--card);padding:12px;border-bottom:1px solid var(--border)}
.titlebar{display:flex;justify-content:space-between;align-items:center}
.titlebar h1{font-size:18px;margin:0}
.titlebar button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 12px}
.persons{display:flex;overflow-x:auto;gap:8px;padding:10px 0}
.person{padding:8px 14px;border-radius:18px;background:#2c2c2e;cursor:pointer}
.person.active{background:var(--accent)}
main{padding:12px}
.controls button{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:#2c2c2e;color:#fff;margin-right:6px}
.controls button.active{background:var(--accent)}
.status{font-size:12px;color:var(--muted);margin-bottom:6px}
pre{background:var(--card);padding:14px;border-radius:12px;white-space:pre-wrap}
canvas{width:100%;height:260px;background:var(--card);border-radius:12px}
</style>
</head>

<body>

<header>
  <div class="titlebar">
    <h1>PilotApp</h1>
    <button onclick="manualRefresh()">â†»</button>
  </div>
  <div class="persons" id="persons"></div>
</header>

<main>
  <div class="controls">
    <button id="btnShort" onclick="setMode('short')">Short</button>
    <button id="btnLong" onclick="setMode('long')">Long</button>
    <button id="btnGraph" onclick="setMode('graph')">ðŸ“ˆ Graph</button>
  </div>

  <div class="controls" id="graphControls" style="display:none">
    <button onclick="setHours(3)">3h</button>
    <button onclick="setHours(6)">6h</button>
    <button onclick="setHours(12)">12h</button>
    <button onclick="setHours(24)">24h</button>
  </div>

  <div class="status" id="status">â€“</div>

  <pre id="content"></pre>
  <canvas id="graph" style="display:none"></canvas>
</main>

<script>
const DATA="data/";
let persons=[],currentKey=null,mode="short",hours=24;

async function loadPersons(){
 const r=await fetch("https://api.github.com/repos/rvfxghpjnm-a11y/PilotApp-View/contents/data");
 const j=await r.json();
 persons=j.filter(f=>f.name.endsWith("_short.json")).map(f=>f.name.replace("_short.json",""));
 currentKey=localStorage.getItem("pilotapp_person")||persons[0];
 renderPersons(); load();
}

function renderPersons(){
 const p=document.getElementById("persons"); p.innerHTML="";
 persons.forEach(k=>{
  const d=document.createElement("div");
  d.className="person"+(k===currentKey?" active":"");
  d.textContent=k.replace("_"," ");
  d.onclick=()=>{currentKey=k;localStorage.setItem("pilotapp_person",k);renderPersons();load();}
  p.appendChild(d);
 })
}

function setMode(m){
 mode=m;
 ["Short","Long","Graph"].forEach(x=>{
  document.getElementById("btn"+x).classList.toggle("active",m===x.toLowerCase())
 });
 document.getElementById("graphControls").style.display=m==="graph"?"block":"none";
 load();
}

function setHours(h){hours=h;drawGraph();}

async function load(){
 document.getElementById("graph").style.display=mode==="graph"?"block":"none";
 document.getElementById("content").style.display=mode==="graph"?"none":"block";

 if(mode==="short"||mode==="long"){
  const r=await fetch(`${DATA}${currentKey}_${mode}.json?ts=${Date.now()}`);
  const j=await r.json();
  content.textContent=j[mode];
 }
 if(mode==="graph") drawGraph();
 status.textContent="Aktualisiert "+new Date().toLocaleTimeString();
}

async function drawGraph(){
 const c=document.getElementById("graph");
 const ctx=c.getContext("2d");
 ctx.clearRect(0,0,c.width,c.height);

 const r=await fetch(`${DATA}workstart_history_${currentKey}.jsonl?ts=${Date.now()}`);
 const lines=(await r.text()).trim().split("\n").map(l=>JSON.parse(l));

 const now=Date.now();
 const from=now-hours*3600000;
 const data=lines.filter(x=>new Date(x.ts).getTime()>=from);

 if(!data.length) return;

 const xs=data.map(x=>new Date(x.ts).getTime());
 const ys=data.map(x=>x.minutes);

 const minX=Math.min(...xs),maxX=Math.max(...xs);
 const minY=Math.min(...ys),maxY=Math.max(...ys);

 ctx.strokeStyle="#0a84ff"; ctx.beginPath();
 data.forEach((p,i)=>{
  const x=(xs[i]-minX)/(maxX-minX)*(c.width-20)+10;
  const y=c.height-((ys[i]-minY)/(maxY-minY)*(c.height-20)+10);
  i?ctx.lineTo(x,y):ctx.moveTo(x,y);
 });
 ctx.stroke();
}

function manualRefresh(){load();}
loadPersons();
setInterval(load,60000);
</script>

</body>
</html>
