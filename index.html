<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>PilotApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0b0b0b;
  color: #fff;
}

header {
  padding: 14px 18px;
  font-size: 20px;
  font-weight: 600;
  background: #121212;
  border-bottom: 1px solid #222;
}

.container {
  padding: 16px;
}

button {
  background: #1e1e1e;
  color: #ccc;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 8px 12px;
  margin-right: 6px;
  cursor: pointer;
}

button.active {
  background: #0a84ff;
  color: #fff;
  border-color: #0a84ff;
}

.card {
  margin-top: 14px;
  background: #151515;
  border-radius: 14px;
  padding: 14px;
}

canvas {
  width: 100% !important;
  height: 320px !important;
}
</style>
</head>

<body>

<header>PilotApp</header>

<div class="container">

  <!-- PERSONEN -->
  <div id="persons"></div>

  <!-- ZEITFENSTER -->
  <div style="margin-top:10px">
    <button onclick="setWindow(3)">3h</button>
    <button onclick="setWindow(6)">6h</button>
    <button onclick="setWindow(12)">12h</button>
    <button class="active" onclick="setWindow(24)">24h</button>
  </div>

  <!-- GRAPH -->
  <div class="card">
    <h3>Workstart-Verlauf</h3>
    <canvas id="chart"></canvas>
  </div>

</div>

<script>
/* ==============================
   KONFIG
============================== */

const PERSONS = [
  "konietzka_stefan",
  "crotogino_philipp"
];

let currentKey = PERSONS[0];
let windowHours = 24;
let chart;

/* ==============================
   INIT
============================== */

renderPersons();
loadWorkstart();

/* ==============================
   UI
============================== */

function renderPersons() {
  const box = document.getElementById("persons");
  box.innerHTML = "";

  PERSONS.forEach(p => {
    const b = document.createElement("button");
    b.textContent = p.replace("_", " ");
    if (p === currentKey) b.classList.add("active");
    b.onclick = () => {
      currentKey = p;
      renderPersons();
      loadWorkstart();
    };
    box.appendChild(b);
  });
}

function setWindow(h) {
  windowHours = h;
  document.querySelectorAll("button").forEach(b => b.classList.remove("active"));
  event.target.classList.add("active");
  loadWorkstart();
}

/* ==============================
   WORKSTART
============================== */

async function loadWorkstart() {
  const url = `data/workstart_history_${currentKey}.json`;

  const res = await fetch(url);
  if (!res.ok) return;

  const data = await res.json();
  const entries = data.entries || [];

  const now = new Date();
  const cutoff = new Date(now - windowHours * 3600 * 1000);

  const filtered = entries.filter(e => {
    const t = parseTime(e.ts_calc);
    return t && t >= cutoff;
  });

  const labels = filtered.map(e => parseTime(e.ts_calc));

  const build = key =>
    filtered.map(e => parseTime(e[key]));

  drawChart(labels, [
    { label: "Meldung",      data: build("from_meldung"),      color: "#0a84ff" },
    { label: "Alt",          data: build("from_meldung_alt"),  color: "#64d2ff" },
    { label: "Div 2",        data: build("calc_div2"),         color: "#30d158" },
    { label: "Div 3",        data: build("calc_div3"),         color: "#ffd60a" }
  ]);
}

/* ==============================
   CHART
============================== */

function drawChart(labels, series) {
  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels,
      datasets: series.map(s => ({
        label: s.label,
        data: s.data,
        borderColor: s.color,
        backgroundColor: s.color,
        spanGaps: true,
        tension: 0.25
      }))
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: "time",
          time: { unit: "hour" },
          ticks: { color: "#aaa" }
        },
        y: {
          reverse: true,
          ticks: { color: "#aaa" }
        }
      },
      plugins: {
        legend: {
          labels: { color: "#ccc" }
        }
      }
    }
  });
}

/* ==============================
   HELPERS
============================== */

function parseTime(val) {
  if (!val) return null;

  // ISO
  if (val.includes("T")) return new Date(val);

  // "Mo12:30"
  const m = val.match(/(\d{2}):(\d{2})$/);
  if (!m) return null;

  const d = new Date();
  d.setHours(+m[1], +m[2], 0, 0);
  return d;
}
</script>

</body>
</html>
