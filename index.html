<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>PilotApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  margin: 0;
  font-family: system-ui;
  background: #0f1218;
  color: #e6e6e6;
}
header {
  padding: 12px 16px;
  border-bottom: 1px solid #1f2633;
}
h1 { margin: 0 0 8px 0; font-size: 22px; }
.row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
button {
  background: #1c2330;
  color: #ccc;
  border: 1px solid #2b3548;
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
}
button.active {
  background: #2f81f7;
  color: #fff;
  border-color: #2f81f7;
}
main { padding: 16px; }
canvas { max-width: 100%; }
.error {
  background: #3a1d1d;
  color: #ffb3b3;
  padding: 12px;
  border-radius: 8px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>

<body>

<header>
<h1>PilotApp</h1>

<div class="row" id="personButtons">Lade Personen …</div>

<div class="row">
  <button id="btnShort">Short</button>
  <button id="btnLong">Long</button>
  <button id="btnGraph" class="active">Graph</button>
  <button id="btnRefresh">⟳ Refresh</button>
  <span id="refreshTime"></span>
</div>

<div class="row">
  <button data-h="3">3h</button>
  <button data-h="6">6h</button>
  <button data-h="12">12h</button>
  <button data-h="24" class="active">24h</button>
</div>
</header>

<main id="content">
<canvas id="chart" height="140"></canvas>
</main>

<script>
/* ============================================================
   KONFIG / STATE
============================================================ */
const REPO = "rvfxghpjnm-a11y/PilotApp-View";
const DATA_PATH = "data";

let persons = [];
let currentPerson = null;
let hoursBack = 24;
let chart = null;

/* ============================================================
   INIT
============================================================ */
document.getElementById("btnRefresh").onclick = init;
document.querySelectorAll("[data-h]").forEach(b => {
  b.onclick = () => {
    document.querySelectorAll("[data-h]").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    hoursBack = Number(b.dataset.h);
    loadGraph();
  };
});

init();

/* ============================================================
   PERSONEN
============================================================ */
async function init() {
  updateRefreshTime();
  await loadPersons();
  renderPersons();
  if (!currentPerson && persons.length) currentPerson = persons[0].key;
  loadGraph();
}

async function loadPersons() {
  const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${DATA_PATH}`);
  const files = await res.json();
  persons = files
    .filter(f => f.name.endsWith("_short.json"))
    .map(f => {
      const key = f.name.replace("_short.json", "");
      const [nachname, vorname] = key.split("_");
      return { key, vorname, nachname };
    });
}

function renderPersons() {
  const el = document.getElementById("personButtons");
  el.innerHTML = "";
  persons.forEach(p => {
    const b = document.createElement("button");
    b.textContent = `${p.vorname} ${p.nachname}`;
    if (p.key === currentPerson) b.classList.add("active");
    b.onclick = () => {
      currentPerson = p.key;
      renderPersons();
      loadGraph();
    };
    el.appendChild(b);
  });
}

/* ============================================================
   GRAPH
============================================================ */
async function loadGraph() {
  const file = `${DATA_PATH}/workstart_history_${currentPerson}.json`;
  const res = await fetch(file, { cache: "no-store" });
  if (!res.ok) return showError("Workstart-Datei fehlt");

  const json = await res.json();
  const cutoff = Date.now() - hoursBack * 3600 * 1000;

  const lines = {
    meldung: [],
    div3: [],
    div2: [],
    real: []
  };

  json.entries.forEach(e => {
    push(lines.meldung, e.from_meldung, cutoff);
    push(lines.div3, e.calc_div3, cutoff);
    push(lines.div2, e.calc_div2, cutoff);
    push(lines.real, e.real_start, cutoff);
  });

  drawChart(lines);
}

function push(arr, str, cutoff) {
  if (!str) return;
  const t = new Date(str.replace(" ", "T"));
  if (t.getTime() < cutoff) return;
  arr.push({ x: t, y: t.getHours() + t.getMinutes() / 60 });
}

function drawChart(lines) {
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      datasets: [
        ds("Meldung", lines.meldung, "#ffb300"),
        ds("Calc /3", lines.div3, "#00c853"),
        ds("Calc /2", lines.div2, "#e53935"),
        ds("Real", lines.real, "#ffffff", true)
      ]
    },
    options: {
      scales: {
        x: { type: "time", time: { unit: "hour" } },
        y: {
          min: 0, max: 24,
          ticks: { stepSize: 2, callback: v => `${Math.floor(v)}:00` }
        }
      }
    }
  });
}

function ds(label, data, color, points=false) {
  return {
    label,
    data,
    borderColor: color,
    backgroundColor: color,
    pointRadius: points ? 4 : 0,
    showLine: !points,
    tension: 0.25
  };
}

function showError(msg) {
  document.getElementById("content").innerHTML =
    `<div class="error">${msg}</div>`;
}

function updateRefreshTime() {
  document.getElementById("refreshTime").textContent =
    new Date().toLocaleTimeString("de-DE");
}
</script>

</body>
</html>